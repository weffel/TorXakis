<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE Safe #-}</span><span>
</span><a name="line-2"></a><span class="hs-comment">{-
Copyright (c) 2006-2011 John Goerzen &lt;jgoerzen@complete.org&gt;

All rights reserved.

For license and copyright information, see the file LICENSE
-}</span><span>
</span><a name="line-9"></a><span>
</span><a name="line-10"></a><span class="hs-comment">{- |
   Module     : Data.Progress.Tracker
   Copyright  : Copyright (C) 2006-2011 John Goerzen
   License    : BSD3

   Maintainer : John Goerzen &lt;jgoerzen@complete.org&gt; 
   Stability  : provisional
   Portability: portable

Tools for tracking the status of a long operation.

Written by John Goerzen, jgoerzen\@complete.org 

See also &quot;Data.Progress.Meter&quot; -}</span><span>
</span><a name="line-24"></a><span>
</span><a name="line-25"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Progress</span><span class="hs-operator">.</span><span class="hs-identifier">Tracker</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-26"></a><span>                                 </span><span class="hs-comment">-- * Introduction</span><span>
</span><a name="line-27"></a><span>                                 </span><span class="hs-comment">-- $introduction</span><span>
</span><a name="line-28"></a><span>                                 </span><span class="hs-comment">-- ** Examples</span><span>
</span><a name="line-29"></a><span>                                 </span><span class="hs-comment">-- $examples</span><span>
</span><a name="line-30"></a><span>                                 </span><span class="hs-comment">-- * Creation and Options</span><span>
</span><a name="line-31"></a><span>                                 </span><a href="Data.Progress.Tracker.html#newProgress"><span class="hs-identifier hs-var">newProgress</span></a><span class="hs-special">,</span><span> </span><a href="Data.Progress.Tracker.html#newProgress%27"><span class="hs-identifier hs-var">newProgress'</span></a><span class="hs-special">,</span><span>
</span><a name="line-32"></a><span>                                 </span><a href="Data.Progress.Tracker.html#addCallback"><span class="hs-identifier hs-var">addCallback</span></a><span class="hs-special">,</span><span> </span><a href="Data.Progress.Tracker.html#addParent"><span class="hs-identifier hs-var">addParent</span></a><span class="hs-special">,</span><span>
</span><a name="line-33"></a><span>                                 </span><span class="hs-comment">-- * Updating</span><span>
</span><a name="line-34"></a><span>                                 </span><a href="Data.Progress.Tracker.html#incrP"><span class="hs-identifier hs-var">incrP</span></a><span class="hs-special">,</span><span> </span><a href="Data.Progress.Tracker.html#incrP%27"><span class="hs-identifier hs-var">incrP'</span></a><span class="hs-special">,</span><span> </span><a href="Data.Progress.Tracker.html#setP"><span class="hs-identifier hs-var">setP</span></a><span class="hs-special">,</span><span> </span><a href="Data.Progress.Tracker.html#setP%27"><span class="hs-identifier hs-var">setP'</span></a><span class="hs-special">,</span><span> </span><a href="Data.Progress.Tracker.html#incrTotal"><span class="hs-identifier hs-var">incrTotal</span></a><span class="hs-special">,</span><span>
</span><a name="line-35"></a><span>                                 </span><a href="Data.Progress.Tracker.html#setTotal"><span class="hs-identifier hs-var">setTotal</span></a><span class="hs-special">,</span><span> </span><a href="Data.Progress.Tracker.html#finishP"><span class="hs-identifier hs-var">finishP</span></a><span class="hs-special">,</span><span>
</span><a name="line-36"></a><span>                                 </span><span class="hs-comment">-- * Reading and Processing</span><span>
</span><a name="line-37"></a><span>                                 </span><a href="Data.Progress.Tracker.html#getSpeed"><span class="hs-identifier hs-var">getSpeed</span></a><span class="hs-special">,</span><span>
</span><a name="line-38"></a><span>                                 </span><a href="Data.Progress.Tracker.html#withStatus"><span class="hs-identifier hs-var">withStatus</span></a><span class="hs-special">,</span><span>
</span><a name="line-39"></a><span>                                 </span><a href="Data.Progress.Tracker.html#getETR"><span class="hs-identifier hs-var">getETR</span></a><span class="hs-special">,</span><span>
</span><a name="line-40"></a><span>                                 </span><a href="Data.Progress.Tracker.html#getETA"><span class="hs-identifier hs-var">getETA</span></a><span class="hs-special">,</span><span>
</span><a name="line-41"></a><span>                                 </span><span class="hs-comment">-- * Types</span><span>
</span><a name="line-42"></a><span>                                 </span><a href="Data.Progress.Tracker.html#ProgressStatus"><span class="hs-identifier hs-type">ProgressStatus</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-43"></a><span>                                 </span><a href="Data.Progress.Tracker.html#Progress"><span class="hs-identifier hs-type">Progress</span></a><span class="hs-special">,</span><span> </span><a href="Data.Progress.Tracker.html#ProgressTimeSource"><span class="hs-identifier hs-type">ProgressTimeSource</span></a><span class="hs-special">,</span><span>
</span><a name="line-44"></a><span>                                 </span><a href="Data.Progress.Tracker.html#ProgressCallback"><span class="hs-identifier hs-type">ProgressCallback</span></a><span class="hs-special">,</span><span>
</span><a name="line-45"></a><span>                                 </span><a href="Data.Progress.Tracker.html#ProgressStatuses"><span class="hs-identifier hs-type">ProgressStatuses</span></a><span class="hs-special">,</span><span>
</span><a name="line-46"></a><span>                                 </span><span class="hs-comment">-- * Utilities</span><span>
</span><a name="line-47"></a><span>                                 </span><a href="Data.Progress.Tracker.html#defaultTimeSource"><span class="hs-identifier hs-var">defaultTimeSource</span></a><span>
</span><a name="line-48"></a><span>                               </span><span class="hs-special">)</span><span>
</span><a name="line-49"></a><span>
</span><a name="line-50"></a><span class="hs-keyword">where</span><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Concurrent</span><span class="hs-operator">.</span><span class="hs-identifier">MVar</span><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System</span><span class="hs-operator">.</span><span class="hs-identifier">Time</span><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span> </span><a href="System.Time.Utils.html"><span class="hs-identifier">System</span><span class="hs-operator">.</span><span class="hs-identifier">Time</span><span class="hs-operator">.</span><span class="hs-identifier">Utils</span></a><span>
</span><a name="line-54"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Ratio</span><span>
</span><a name="line-55"></a><span>
</span><a name="line-56"></a><span class="hs-comment">{- $introduction

ProgressTracker is a module for tracking the progress on long-running
operations.  It can be thought of as the back end engine behind
a status bar.  ProgressTracker can do things such as track how far along
a task is, provide an estimated time of completion, estimated time remaining,
current speed, etc.  It is designed to be as generic as possible; it can even
base its speed calculations on something other than the system clock.

ProgressTracker also supports a notion of a parent tracker.  This is used when
a large task is composed of several individual tasks which may also be
long-running.  Downloading many large files over the Internet is a common
example of this.

Any given ProgressTracker can be told about one or more parent trackers.  
When the child tracker's status is updated, the parent tracker's status is
also updated in the same manner.  Therefore, the progress on each individual
component, as well as the overall progress, can all be kept in sync
automatically.

Finally, you can register callbacks.  Callbacks are functions that are called
whenever the status of a tracker changes.  They'll be passed the old and new
status and are intended to do things like update on-screen status displays.

The cousin module 'Data.Progress.Meter' can be used to nicely render
these trackers on a console.
-}</span><span>
</span><a name="line-83"></a><span>
</span><a name="line-84"></a><span class="hs-comment">{- $examples

Here is an example use:

&gt;do prog &lt;- newProgress &quot;mytracker&quot; 1024
&gt;   incrP prog 10
&gt;   getETR prog &gt;&gt;= print           -- prints number of seconds remaining
&gt;   incrP prog 500
&gt;   finishP prog
-}</span><span>
</span><a name="line-94"></a><span>
</span><a name="line-95"></a><span class="hs-comment">----------------------------------------------------------------------</span><span>
</span><a name="line-96"></a><span class="hs-comment">-- TYPES</span><span>
</span><a name="line-97"></a><span class="hs-comment">----------------------------------------------------------------------</span><span>
</span><a name="line-98"></a><span>
</span><a name="line-99"></a><span class="hs-comment">{- | A function that, when called, yields the current time. 
The default is 'defaultTimeSource'. -}</span><span>
</span><a name="line-101"></a><span class="hs-keyword">type</span><span> </span><a name="ProgressTimeSource"><a href="Data.Progress.Tracker.html#ProgressTimeSource"><span class="hs-identifier">ProgressTimeSource</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">Integer</span><span>
</span><a name="line-102"></a><span>
</span><a name="line-103"></a><span class="hs-comment">{- | The type for a callback function for the progress tracker.
When given at creation time to 'newProgress\'' or when added via 'addCallback',
these functions get called every time the status of the tracker changes.

This function is passed two 'ProgressStatus' records: the first
reflects the status prior to the update, and the second reflects
the status after the update.

Please note that the owning 'Progress' object will be locked while the
callback is running, so the callback will not be able to make changes to it. -}</span><span>
</span><a name="line-113"></a><span class="hs-keyword">type</span><span> </span><a name="ProgressCallback"><a href="Data.Progress.Tracker.html#ProgressCallback"><span class="hs-identifier">ProgressCallback</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Progress.Tracker.html#ProgressStatus"><span class="hs-identifier hs-type">ProgressStatus</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Progress.Tracker.html#ProgressStatus"><span class="hs-identifier hs-type">ProgressStatus</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-114"></a><span>
</span><a name="line-115"></a><span class="hs-comment">{- | The main progress status record. -}</span><span>
</span><a name="line-116"></a><span class="hs-keyword">data</span><span> </span><a name="ProgressStatus"><a href="Data.Progress.Tracker.html#ProgressStatus"><span class="hs-identifier">ProgressStatus</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span>
</span><a name="line-117"></a><span>     </span><a name="ProgressStatus"><a href="Data.Progress.Tracker.html#ProgressStatus"><span class="hs-identifier">ProgressStatus</span></a></a><span> </span><span class="hs-special">{</span><a name="completedUnits"><a href="Data.Progress.Tracker.html#completedUnits"><span class="hs-identifier">completedUnits</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Integer</span><span class="hs-special">,</span><span>
</span><a name="line-118"></a><span>                     </span><a name="totalUnits"><a href="Data.Progress.Tracker.html#totalUnits"><span class="hs-identifier">totalUnits</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Integer</span><span class="hs-special">,</span><span>
</span><a name="line-119"></a><span>                     </span><a name="startTime"><a href="Data.Progress.Tracker.html#startTime"><span class="hs-identifier">startTime</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Integer</span><span class="hs-special">,</span><span>
</span><a name="line-120"></a><span>                     </span><a name="trackerName"><a href="Data.Progress.Tracker.html#trackerName"><span class="hs-identifier">trackerName</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span class="hs-special">,</span><span> </span><span class="hs-comment">-- ^ An identifying string</span><span>
</span><a name="line-121"></a><span>                     </span><a name="timeSource"><a href="Data.Progress.Tracker.html#timeSource"><span class="hs-identifier">timeSource</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Progress.Tracker.html#ProgressTimeSource"><span class="hs-identifier hs-type">ProgressTimeSource</span></a><span>
</span><a name="line-122"></a><span>                    </span><span class="hs-special">}</span><span>
</span><a name="line-123"></a><span>
</span><a name="line-124"></a><span class="hs-keyword">data</span><span> </span><a name="ProgressRecord"><a href="Data.Progress.Tracker.html#ProgressRecord"><span class="hs-identifier">ProgressRecord</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-125"></a><span>    </span><a name="ProgressRecord"><a href="Data.Progress.Tracker.html#ProgressRecord"><span class="hs-identifier">ProgressRecord</span></a></a><span> </span><span class="hs-special">{</span><a name="parents"><a href="Data.Progress.Tracker.html#parents"><span class="hs-identifier">parents</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Data.Progress.Tracker.html#Progress"><span class="hs-identifier hs-type">Progress</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-126"></a><span>                    </span><a name="callbacks"><a href="Data.Progress.Tracker.html#callbacks"><span class="hs-identifier">callbacks</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Data.Progress.Tracker.html#ProgressCallback"><span class="hs-identifier hs-type">ProgressCallback</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-127"></a><span>                    </span><a name="status"><a href="Data.Progress.Tracker.html#status"><span class="hs-identifier">status</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Progress.Tracker.html#ProgressStatus"><span class="hs-identifier hs-type">ProgressStatus</span></a><span class="hs-special">}</span><span>
</span><a name="line-128"></a><span>
</span><a name="line-129"></a><span class="hs-comment">{- | The main Progress object. -}</span><span>
</span><a name="line-130"></a><span class="hs-keyword">newtype</span><span> </span><a name="Progress"><a href="Data.Progress.Tracker.html#Progress"><span class="hs-identifier">Progress</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Progress"><a href="Data.Progress.Tracker.html#Progress"><span class="hs-identifier">Progress</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MVar</span><span> </span><a href="Data.Progress.Tracker.html#ProgressRecord"><span class="hs-identifier hs-type">ProgressRecord</span></a><span class="hs-special">)</span><span>
</span><a name="line-131"></a><span>
</span><a name="line-132"></a><span class="hs-keyword">class</span><span> </span><a name="ProgressStatuses"><a href="Data.Progress.Tracker.html#ProgressStatuses"><span class="hs-identifier">ProgressStatuses</span></a></a><span> </span><a name="local-6989586621679077197"><a href="#local-6989586621679077197"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679077198"><a href="#local-6989586621679077198"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-133"></a><span>    </span><span class="hs-comment">{- | Lets you examine the 'ProgressStatus' that is contained 
       within a 'Progress' object.  You can simply pass
       a 'Progress' object and a function to 'withStatus', and
       'withStatus' will lock the 'Progress' object (blocking any
       modifications while you are reading it), then pass the object
       to your function.  If you happen to already have a 'ProgressStatus'
       object, withStatus will also accept it and simply pass it unmodified
       to the function. -}</span><span>
</span><a name="line-141"></a><span>    </span><span class="hs-identifier">withStatus</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679077197"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Data.Progress.Tracker.html#ProgressStatus"><span class="hs-identifier hs-type">ProgressStatus</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679077198"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679077198"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-142"></a><span>
</span><a name="line-143"></a><span class="hs-keyword">class</span><span> </span><a name="ProgressRecords"><a href="Data.Progress.Tracker.html#ProgressRecords"><span class="hs-identifier">ProgressRecords</span></a></a><span> </span><a name="local-6989586621679077195"><a href="#local-6989586621679077195"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679077196"><a href="#local-6989586621679077196"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-144"></a><span>    </span><span class="hs-identifier">withRecord</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679077195"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Data.Progress.Tracker.html#ProgressRecord"><span class="hs-identifier hs-type">ProgressRecord</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679077196"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679077196"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-145"></a><span>
</span><a name="line-146"></a><span class="hs-comment">{-
instance ProgressStatuses ProgressRecord b where
    withStatus x func = func (status x)
instance ProgressRecords ProgressRecord b where
    withRecord x func = func x
-}</span><span>
</span><a name="line-152"></a><span>
</span><a name="line-153"></a><span class="hs-keyword">instance</span><span> </span><a href="Data.Progress.Tracker.html#ProgressStatuses"><span class="hs-identifier hs-type">ProgressStatuses</span></a><span> </span><a href="Data.Progress.Tracker.html#Progress"><span class="hs-identifier hs-type">Progress</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679077274"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-154"></a><span>    </span><a name="local-8214565720323852071"><a href="Data.Progress.Tracker.html#withStatus"><span class="hs-identifier">withStatus</span></a></a><span> </span><span class="hs-special">(</span><a href="Data.Progress.Tracker.html#Progress"><span class="hs-identifier hs-var">Progress</span></a><span> </span><a name="local-6989586621679077275"><a href="#local-6989586621679077275"><span class="hs-identifier">x</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679077276"><a href="#local-6989586621679077276"><span class="hs-identifier">func</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">withMVar</span><span> </span><a href="#local-6989586621679077275"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679077277"><a href="#local-6989586621679077277"><span class="hs-identifier">y</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679077276"><span class="hs-identifier hs-var">func</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">status</span><span> </span><a href="#local-6989586621679077277"><span class="hs-identifier hs-var">y</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-155"></a><span class="hs-keyword">instance</span><span> </span><a href="Data.Progress.Tracker.html#ProgressRecords"><span class="hs-identifier hs-type">ProgressRecords</span></a><span> </span><a href="Data.Progress.Tracker.html#Progress"><span class="hs-identifier hs-type">Progress</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679077271"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-156"></a><span>    </span><a name="local-8214565720323852069"><a href="Data.Progress.Tracker.html#withRecord"><span class="hs-identifier">withRecord</span></a></a><span> </span><span class="hs-special">(</span><a href="Data.Progress.Tracker.html#Progress"><span class="hs-identifier hs-var">Progress</span></a><span> </span><a name="local-6989586621679077272"><a href="#local-6989586621679077272"><span class="hs-identifier">x</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679077273"><a href="#local-6989586621679077273"><span class="hs-identifier">func</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">withMVar</span><span> </span><a href="#local-6989586621679077272"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621679077273"><span class="hs-identifier hs-var">func</span></a><span>
</span><a name="line-157"></a><span>
</span><a name="line-158"></a><span class="hs-keyword">instance</span><span> </span><a href="Data.Progress.Tracker.html#ProgressStatuses"><span class="hs-identifier hs-type">ProgressStatuses</span></a><span> </span><a href="Data.Progress.Tracker.html#ProgressStatus"><span class="hs-identifier hs-type">ProgressStatus</span></a><span> </span><a href="#local-6989586621679077268"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-159"></a><span>    </span><a name="local-8214565720323852071"><a href="Data.Progress.Tracker.html#withStatus"><span class="hs-identifier">withStatus</span></a></a><span> </span><a name="local-6989586621679077269"><a href="#local-6989586621679077269"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621679077270"><a href="#local-6989586621679077270"><span class="hs-identifier">func</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679077270"><span class="hs-identifier hs-var">func</span></a><span> </span><a href="#local-6989586621679077269"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-160"></a><span>
</span><a name="line-161"></a><span class="hs-comment">----------------------------------------------------------------------</span><span>
</span><a name="line-162"></a><span class="hs-comment">-- Creation</span><span>
</span><a name="line-163"></a><span class="hs-comment">----------------------------------------------------------------------</span><span>
</span><a name="line-164"></a><span>
</span><a name="line-165"></a><span class="hs-comment">{- | Create a new 'Progress' object with the given name and number
of total units initialized as given.  The start time will be initialized
with the current time at the present moment according to the system clock.
The units completed will be set to 0, the time source will be set to the
system clock, and the parents and callbacks will be empty.

If you need more control, see 'newProgress\''.

Example:

&gt; prog &lt;- newProgress &quot;mytracker&quot; 1024

-}</span><span>
</span><a name="line-178"></a><span class="hs-identifier">newProgress</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span>           </span><span class="hs-comment">-- ^ Name of this tracker</span><span>
</span><a name="line-179"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Integer</span><span>          </span><span class="hs-comment">-- ^ Total units expected</span><span>
</span><a name="line-180"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Data.Progress.Tracker.html#Progress"><span class="hs-identifier hs-type">Progress</span></a><span>
</span><a name="line-181"></a><a name="newProgress"><a href="Data.Progress.Tracker.html#newProgress"><span class="hs-identifier">newProgress</span></a></a><span> </span><a name="local-6989586621679077204"><a href="#local-6989586621679077204"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621679077205"><a href="#local-6989586621679077205"><span class="hs-identifier">total</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-182"></a><span>    </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621679077206"><a href="#local-6989586621679077206"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Progress.Tracker.html#defaultTimeSource"><span class="hs-identifier hs-var">defaultTimeSource</span></a><span>
</span><a name="line-183"></a><span>       </span><a href="Data.Progress.Tracker.html#newProgress%27"><span class="hs-identifier hs-var">newProgress'</span></a><span> </span><span class="hs-special">(</span><a href="Data.Progress.Tracker.html#ProgressStatus"><span class="hs-identifier hs-var">ProgressStatus</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">completedUnits</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">totalUnits</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679077205"><span class="hs-identifier hs-var">total</span></a><span class="hs-special">,</span><span>
</span><a name="line-184"></a><span>                                     </span><span class="hs-identifier">startTime</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679077206"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">trackerName</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679077204"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">,</span><span>
</span><a name="line-185"></a><span>                                     </span><span class="hs-identifier">timeSource</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Progress.Tracker.html#defaultTimeSource"><span class="hs-identifier hs-var">defaultTimeSource</span></a><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-186"></a><span>                    </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-187"></a><span>
</span><a name="line-188"></a><span class="hs-comment">{- | Create a new 'Progress' object initialized with the given status and 
callbacks.
No adjustment to the 'startTime' will be made.  If you
want to use the system clock, you can initialize 'startTime' with
the return value of 'defaultTimeSource' and also pass 'defaultTimeSource'
as the timing source. -}</span><span>
</span><a name="line-194"></a><span class="hs-identifier">newProgress'</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Progress.Tracker.html#ProgressStatus"><span class="hs-identifier hs-type">ProgressStatus</span></a><span>
</span><a name="line-195"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Data.Progress.Tracker.html#ProgressCallback"><span class="hs-identifier hs-type">ProgressCallback</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Data.Progress.Tracker.html#Progress"><span class="hs-identifier hs-type">Progress</span></a><span>
</span><a name="line-196"></a><a name="newProgress%27"><a href="Data.Progress.Tracker.html#newProgress%27"><span class="hs-identifier">newProgress'</span></a></a><span> </span><a name="local-6989586621679077207"><a href="#local-6989586621679077207"><span class="hs-identifier">news</span></a></a><span> </span><a name="local-6989586621679077208"><a href="#local-6989586621679077208"><span class="hs-identifier">newcb</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-197"></a><span>    </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621679077209"><a href="#local-6989586621679077209"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newMVar</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Progress.Tracker.html#ProgressRecord"><span class="hs-identifier hs-var">ProgressRecord</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">parents</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-198"></a><span>                                      </span><span class="hs-identifier">callbacks</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679077208"><span class="hs-identifier hs-var">newcb</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">status</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679077207"><span class="hs-identifier hs-var">news</span></a><span class="hs-special">}</span><span>
</span><a name="line-199"></a><span>       </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="Data.Progress.Tracker.html#Progress"><span class="hs-identifier hs-var">Progress</span></a><span> </span><a href="#local-6989586621679077209"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-200"></a><span>
</span><a name="line-201"></a><span class="hs-comment">{- | Adds an new callback to an existing 'Progress'.  The callback will be
called whenever the object's status is updated, except by the call to finishP.

Please note that the Progress object will be locked while the callback is 
running, so the callback will not be able to make any modifications to it.
-}</span><span>
</span><a name="line-207"></a><span class="hs-identifier">addCallback</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Progress.Tracker.html#Progress"><span class="hs-identifier hs-type">Progress</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Progress.Tracker.html#ProgressCallback"><span class="hs-identifier hs-type">ProgressCallback</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-208"></a><a name="addCallback"><a href="Data.Progress.Tracker.html#addCallback"><span class="hs-identifier">addCallback</span></a></a><span> </span><span class="hs-special">(</span><a href="Data.Progress.Tracker.html#Progress"><span class="hs-identifier hs-var">Progress</span></a><span> </span><a name="local-6989586621679077210"><a href="#local-6989586621679077210"><span class="hs-identifier">mpo</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679077211"><a href="#local-6989586621679077211"><span class="hs-identifier">cb</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">modifyMVar_</span><span> </span><a href="#local-6989586621679077210"><span class="hs-identifier hs-var">mpo</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679077212"><a href="#local-6989586621679077212"><span class="hs-identifier">po</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-209"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679077212"><span class="hs-identifier hs-var">po</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">callbacks</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679077211"><span class="hs-identifier hs-var">cb</span></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">callbacks</span><span> </span><a href="#local-6989586621679077212"><span class="hs-identifier hs-var">po</span></a><span class="hs-special">}</span><span>
</span><a name="line-210"></a><span>
</span><a name="line-211"></a><span class="hs-comment">{- | Adds a new parent to an existing 'Progress'.  The parent
will automatically have its completed and total counters incremented
by the value of those counters in the existing 'Progress'. -}</span><span>
</span><a name="line-214"></a><span class="hs-identifier">addParent</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Progress.Tracker.html#Progress"><span class="hs-identifier hs-type">Progress</span></a><span>           </span><span class="hs-comment">-- ^ The child object</span><span>
</span><a name="line-215"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Progress.Tracker.html#Progress"><span class="hs-identifier hs-type">Progress</span></a><span>           </span><span class="hs-comment">-- ^ The parent to add to this child</span><span>
</span><a name="line-216"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-217"></a><a name="addParent"><a href="Data.Progress.Tracker.html#addParent"><span class="hs-identifier">addParent</span></a></a><span> </span><span class="hs-special">(</span><a href="Data.Progress.Tracker.html#Progress"><span class="hs-identifier hs-var">Progress</span></a><span> </span><a name="local-6989586621679077213"><a href="#local-6989586621679077213"><span class="hs-identifier">mcpo</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679077214"><a href="#local-6989586621679077214"><span class="hs-identifier">ppo</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">modifyMVar_</span><span> </span><a href="#local-6989586621679077213"><span class="hs-identifier hs-var">mcpo</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679077215"><a href="#local-6989586621679077215"><span class="hs-identifier">cpo</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-218"></a><span>    </span><span class="hs-keyword">do</span><span> </span><a href="Data.Progress.Tracker.html#incrP%27"><span class="hs-identifier hs-var">incrP'</span></a><span> </span><a href="#local-6989586621679077214"><span class="hs-identifier hs-var">ppo</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">completedUnits</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">status</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679077215"><span class="hs-identifier hs-var">cpo</span></a><span class="hs-special">)</span><span>
</span><a name="line-219"></a><span>       </span><a href="Data.Progress.Tracker.html#incrTotal"><span class="hs-identifier hs-var">incrTotal</span></a><span> </span><a href="#local-6989586621679077214"><span class="hs-identifier hs-var">ppo</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">totalUnits</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">status</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679077215"><span class="hs-identifier hs-var">cpo</span></a><span class="hs-special">)</span><span>
</span><a name="line-220"></a><span>       </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679077215"><span class="hs-identifier hs-var">cpo</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">parents</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679077214"><span class="hs-identifier hs-var">ppo</span></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">parents</span><span> </span><a href="#local-6989586621679077215"><span class="hs-identifier hs-var">cpo</span></a><span class="hs-special">}</span><span>
</span><a name="line-221"></a><span>
</span><a name="line-222"></a><span class="hs-comment">{- | Call this when you are finished with the object.  It is especially
important to do this when parent objects are involved.

This will simply set the totalUnits to the current completedUnits count,
but will not call the callbacks.  It will additionally propogate
any adjustment in totalUnits to the parents, whose callbacks /will/ be
called.

This ensures that the total expected counts on the parent are always correct.
Without doing this, if, say, a transfer ended earlier than expected, ETA 
values on the parent would be off since it would be expecting more data than
actually arrived. -}</span><span>
</span><a name="line-234"></a><span class="hs-identifier">finishP</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Progress.Tracker.html#Progress"><span class="hs-identifier hs-type">Progress</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-235"></a><a name="finishP"><a href="Data.Progress.Tracker.html#finishP"><span class="hs-identifier">finishP</span></a></a><span> </span><span class="hs-special">(</span><a href="Data.Progress.Tracker.html#Progress"><span class="hs-identifier hs-var">Progress</span></a><span> </span><a name="local-6989586621679077216"><a href="#local-6989586621679077216"><span class="hs-identifier">mp</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-236"></a><span>    </span><span class="hs-identifier hs-var">modifyMVar_</span><span> </span><a href="#local-6989586621679077216"><span class="hs-identifier hs-var">mp</span></a><span> </span><a href="#local-6989586621679077217"><span class="hs-identifier hs-var">modfunc</span></a><span>
</span><a name="line-237"></a><span>    </span><span class="hs-keyword">where</span><span> </span><span class="hs-identifier">modfunc</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Progress.Tracker.html#ProgressRecord"><span class="hs-identifier hs-type">ProgressRecord</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Data.Progress.Tracker.html#ProgressRecord"><span class="hs-identifier hs-type">ProgressRecord</span></a><span>
</span><a name="line-238"></a><span>          </span><a name="local-6989586621679077217"><a href="#local-6989586621679077217"><span class="hs-identifier">modfunc</span></a></a><span> </span><a name="local-6989586621679077218"><a href="#local-6989586621679077218"><span class="hs-identifier">oldpr</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-239"></a><span>              </span><span class="hs-keyword">do</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679077219"><a href="#local-6989586621679077219"><span class="hs-identifier">adjustment</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">completedUnits</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">status</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679077218"><span class="hs-identifier hs-var">oldpr</span></a><span class="hs-special">)</span><span> </span><span>
</span><a name="line-240"></a><span>                                  </span><span class="hs-glyph">-</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">totalUnits</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">status</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679077218"><span class="hs-identifier hs-var">oldpr</span></a><span class="hs-special">)</span><span>
</span><a name="line-241"></a><span>                 </span><a href="Data.Progress.Tracker.html#callParents"><span class="hs-identifier hs-var">callParents</span></a><span> </span><a href="#local-6989586621679077218"><span class="hs-identifier hs-var">oldpr</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679077220"><a href="#local-6989586621679077220"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Progress.Tracker.html#incrTotal"><span class="hs-identifier hs-var">incrTotal</span></a><span> </span><a href="#local-6989586621679077220"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621679077219"><span class="hs-identifier hs-var">adjustment</span></a><span class="hs-special">)</span><span>
</span><a name="line-242"></a><span>                 </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679077218"><span class="hs-identifier hs-var">oldpr</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">status</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">status</span><span> </span><a href="#local-6989586621679077218"><span class="hs-identifier hs-var">oldpr</span></a><span class="hs-special">)</span><span> </span><span>
</span><a name="line-243"></a><span>                                 </span><span class="hs-special">{</span><span class="hs-identifier">totalUnits</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">completedUnits</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">status</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679077218"><span class="hs-identifier hs-var">oldpr</span></a><span class="hs-special">}</span><span class="hs-special">}</span><span>
</span><a name="line-244"></a><span>
</span><a name="line-245"></a><span class="hs-comment">----------------------------------------------------------------------</span><span>
</span><a name="line-246"></a><span class="hs-comment">-- Updating</span><span>
</span><a name="line-247"></a><span class="hs-comment">----------------------------------------------------------------------</span><span>
</span><a name="line-248"></a><span class="hs-comment">{- | Increment the completed unit count in the 'Progress' object
by the amount given.  If the value as given exceeds the total, then
the total will also be raised to match this value so that the 
completed count never exceeds the total.

You can decrease the completed unit count by supplying a negative number
here. -}</span><span>
</span><a name="line-255"></a><span class="hs-identifier">incrP</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Progress.Tracker.html#Progress"><span class="hs-identifier hs-type">Progress</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Integer</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-256"></a><a name="incrP"><a href="Data.Progress.Tracker.html#incrP"><span class="hs-identifier">incrP</span></a></a><span> </span><a name="local-6989586621679077221"><a href="#local-6989586621679077221"><span class="hs-identifier">po</span></a></a><span> </span><a name="local-6989586621679077222"><a href="#local-6989586621679077222"><span class="hs-identifier">count</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Progress.Tracker.html#modStatus"><span class="hs-identifier hs-var">modStatus</span></a><span> </span><a href="#local-6989586621679077221"><span class="hs-identifier hs-var">po</span></a><span> </span><a href="#local-6989586621679077223"><span class="hs-identifier hs-var">statusfunc</span></a><span>
</span><a name="line-257"></a><span>    </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621679077223"><a href="#local-6989586621679077223"><span class="hs-identifier">statusfunc</span></a></a><span> </span><a name="local-6989586621679077225"><a href="#local-6989586621679077225"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span>
</span><a name="line-258"></a><span>             </span><a href="#local-6989586621679077225"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">completedUnits</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679077224"><span class="hs-identifier hs-var">newcu</span></a><span> </span><a href="#local-6989586621679077225"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">,</span><span>
</span><a name="line-259"></a><span>                </span><span class="hs-identifier">totalUnits</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679077224"><span class="hs-identifier hs-var">newcu</span></a><span> </span><a href="#local-6989586621679077225"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-identifier">totalUnits</span><span> </span><a href="#local-6989586621679077225"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-260"></a><span>                                 </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621679077224"><span class="hs-identifier hs-var">newcu</span></a><span> </span><a href="#local-6989586621679077225"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-261"></a><span>                                 </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier">totalUnits</span><span> </span><a href="#local-6989586621679077225"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">}</span><span>
</span><a name="line-262"></a><span>          </span><a name="local-6989586621679077224"><a href="#local-6989586621679077224"><span class="hs-identifier">newcu</span></a></a><span> </span><a name="local-6989586621679077226"><a href="#local-6989586621679077226"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">completedUnits</span><span> </span><a href="#local-6989586621679077226"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621679077222"><span class="hs-identifier hs-var">count</span></a><span>                  </span><span>
</span><a name="line-263"></a><span>
</span><a name="line-264"></a><span class="hs-comment">{- | Like 'incrP', but never modify the total. -}</span><span>
</span><a name="line-265"></a><span class="hs-identifier">incrP'</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Progress.Tracker.html#Progress"><span class="hs-identifier hs-type">Progress</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Integer</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-266"></a><a name="incrP%27"><a href="Data.Progress.Tracker.html#incrP%27"><span class="hs-identifier">incrP'</span></a></a><span> </span><a name="local-6989586621679077227"><a href="#local-6989586621679077227"><span class="hs-identifier">po</span></a></a><span> </span><a name="local-6989586621679077228"><a href="#local-6989586621679077228"><span class="hs-identifier">count</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span>
</span><a name="line-267"></a><span>    </span><a href="Data.Progress.Tracker.html#modStatus"><span class="hs-identifier hs-var">modStatus</span></a><span> </span><a href="#local-6989586621679077227"><span class="hs-identifier hs-var">po</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679077229"><a href="#local-6989586621679077229"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679077229"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">completedUnits</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">completedUnits</span><span> </span><a href="#local-6989586621679077229"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621679077228"><span class="hs-identifier hs-var">count</span></a><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-268"></a><span>
</span><a name="line-269"></a><span class="hs-comment">{- | Set the completed unit count in the 'Progress' object to the specified
value.  Unlike 'incrP', this function sets the count to a specific value,
rather than adding to the existing value.  If this value exceeds the total,
then the total will also be raised to match this value so that the completed
count never exceeds teh total. -}</span><span>
</span><a name="line-274"></a><span class="hs-identifier">setP</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Progress.Tracker.html#Progress"><span class="hs-identifier hs-type">Progress</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Integer</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-275"></a><a name="setP"><a href="Data.Progress.Tracker.html#setP"><span class="hs-identifier">setP</span></a></a><span> </span><a name="local-6989586621679077230"><a href="#local-6989586621679077230"><span class="hs-identifier">po</span></a></a><span> </span><a name="local-6989586621679077231"><a href="#local-6989586621679077231"><span class="hs-identifier">count</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Progress.Tracker.html#modStatus"><span class="hs-identifier hs-var">modStatus</span></a><span> </span><a href="#local-6989586621679077230"><span class="hs-identifier hs-var">po</span></a><span> </span><a href="#local-6989586621679077232"><span class="hs-identifier hs-var">statusfunc</span></a><span>
</span><a name="line-276"></a><span>    </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621679077232"><a href="#local-6989586621679077232"><span class="hs-identifier">statusfunc</span></a></a><span> </span><a name="local-6989586621679077233"><a href="#local-6989586621679077233"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-277"></a><span>              </span><a href="#local-6989586621679077233"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">completedUnits</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679077231"><span class="hs-identifier hs-var">count</span></a><span class="hs-special">,</span><span>
</span><a name="line-278"></a><span>                 </span><span class="hs-identifier">totalUnits</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679077231"><span class="hs-identifier hs-var">count</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-identifier">totalUnits</span><span> </span><a href="#local-6989586621679077233"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-279"></a><span>                                  </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621679077231"><span class="hs-identifier hs-var">count</span></a><span>
</span><a name="line-280"></a><span>                                  </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier">totalUnits</span><span> </span><a href="#local-6989586621679077233"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">}</span><span>
</span><a name="line-281"></a><span>
</span><a name="line-282"></a><span class="hs-comment">{- | Like 'setP', but never modify the total. -}</span><span>
</span><a name="line-283"></a><span class="hs-identifier">setP'</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Progress.Tracker.html#Progress"><span class="hs-identifier hs-type">Progress</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Integer</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-284"></a><a name="setP%27"><a href="Data.Progress.Tracker.html#setP%27"><span class="hs-identifier">setP'</span></a></a><span> </span><a name="local-6989586621679077234"><a href="#local-6989586621679077234"><span class="hs-identifier">po</span></a></a><span> </span><a name="local-6989586621679077235"><a href="#local-6989586621679077235"><span class="hs-identifier">count</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Progress.Tracker.html#modStatus"><span class="hs-identifier hs-var">modStatus</span></a><span> </span><a href="#local-6989586621679077234"><span class="hs-identifier hs-var">po</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679077236"><a href="#local-6989586621679077236"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679077236"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">completedUnits</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679077235"><span class="hs-identifier hs-var">count</span></a><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-285"></a><span>
</span><a name="line-286"></a><span class="hs-comment">{- | Increment the total unit count in the 'Progress' object by the amount
given.  This would rarely be needed, but could be needed in some special cases 
when the total number of units is not known in advance. -}</span><span>
</span><a name="line-289"></a><span class="hs-identifier">incrTotal</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Progress.Tracker.html#Progress"><span class="hs-identifier hs-type">Progress</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Integer</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-290"></a><a name="incrTotal"><a href="Data.Progress.Tracker.html#incrTotal"><span class="hs-identifier">incrTotal</span></a></a><span> </span><a name="local-6989586621679077237"><a href="#local-6989586621679077237"><span class="hs-identifier">po</span></a></a><span> </span><a name="local-6989586621679077238"><a href="#local-6989586621679077238"><span class="hs-identifier">count</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span>
</span><a name="line-291"></a><span>    </span><a href="Data.Progress.Tracker.html#modStatus"><span class="hs-identifier hs-var">modStatus</span></a><span> </span><a href="#local-6989586621679077237"><span class="hs-identifier hs-var">po</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679077239"><a href="#local-6989586621679077239"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679077239"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">totalUnits</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">totalUnits</span><span> </span><a href="#local-6989586621679077239"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621679077238"><span class="hs-identifier hs-var">count</span></a><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-292"></a><span>
</span><a name="line-293"></a><span class="hs-comment">{- | Set the total unit count in the 'Progress' object to the specified
value.  Like 'incrTotal', this would rarely be needed. -}</span><span>
</span><a name="line-295"></a><span class="hs-identifier">setTotal</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Progress.Tracker.html#Progress"><span class="hs-identifier hs-type">Progress</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Integer</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-296"></a><a name="setTotal"><a href="Data.Progress.Tracker.html#setTotal"><span class="hs-identifier">setTotal</span></a></a><span> </span><a name="local-6989586621679077240"><a href="#local-6989586621679077240"><span class="hs-identifier">po</span></a></a><span> </span><a name="local-6989586621679077241"><a href="#local-6989586621679077241"><span class="hs-identifier">count</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-297"></a><span>    </span><a href="Data.Progress.Tracker.html#modStatus"><span class="hs-identifier hs-var">modStatus</span></a><span> </span><a href="#local-6989586621679077240"><span class="hs-identifier hs-var">po</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679077242"><a href="#local-6989586621679077242"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679077242"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">totalUnits</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679077241"><span class="hs-identifier hs-var">count</span></a><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-298"></a><span>
</span><a name="line-299"></a><span class="hs-comment">----------------------------------------------------------------------</span><span>
</span><a name="line-300"></a><span class="hs-comment">-- Reading and Processing</span><span>
</span><a name="line-301"></a><span class="hs-comment">----------------------------------------------------------------------</span><span>
</span><a name="line-302"></a><span>
</span><a name="line-303"></a><span class="hs-comment">{- | Returns the speed in units processed per time unit.  (If you are
using the default time source, this would be units processed per second).
This obtains the current speed solely from analyzing the 'Progress' object.

If no time has elapsed yet, returns 0.

You can use this against either a 'Progress' object or a 'ProgressStatus'
object.  This is in the IO monad because the speed is based on the current
time.

Example:

&gt; getSpeed progressobj &gt;&gt;= print

Don't let the type of this function confuse you.  It is a fancy way of saying
that it can take either a 'Progress' or a 'ProgressStatus' object, and returns
a number that is valid as any Fractional type, such as a Double, Float, or
Rational. -}</span><span>
</span><a name="line-321"></a><span class="hs-identifier">getSpeed</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Data.Progress.Tracker.html#ProgressStatuses"><span class="hs-identifier hs-type">ProgressStatuses</span></a><span> </span><a href="#local-6989586621679077202"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679077203"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Fractional</span><span> </span><a href="#local-6989586621679077203"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679077202"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679077203"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-322"></a><a name="getSpeed"><a href="Data.Progress.Tracker.html#getSpeed"><span class="hs-identifier">getSpeed</span></a></a><span> </span><a name="local-6989586621679077243"><a href="#local-6989586621679077243"><span class="hs-identifier">po</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Progress.Tracker.html#withStatus"><span class="hs-identifier hs-var">withStatus</span></a><span> </span><a href="#local-6989586621679077243"><span class="hs-identifier hs-var">po</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679077244"><a href="#local-6989586621679077244"><span class="hs-identifier">status</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span>
</span><a name="line-323"></a><span>                </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621679077245"><a href="#local-6989586621679077245"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">timeSource</span><span> </span><a href="#local-6989586621679077244"><span class="hs-identifier hs-var">status</span></a><span>
</span><a name="line-324"></a><span>                   </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679077246"><a href="#local-6989586621679077246"><span class="hs-identifier">elapsed</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679077245"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">startTime</span><span> </span><a href="#local-6989586621679077244"><span class="hs-identifier hs-var">status</span></a><span class="hs-special">)</span><span>
</span><a name="line-325"></a><span>                   </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679077246"><span class="hs-identifier hs-var">elapsed</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-326"></a><span>                       </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">fromRational</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-327"></a><span>                       </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">fromRational</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier">completedUnits</span><span> </span><a href="#local-6989586621679077244"><span class="hs-identifier hs-var">status</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">%</span><span> </span><a href="#local-6989586621679077246"><span class="hs-identifier hs-var">elapsed</span></a><span class="hs-special">)</span><span>
</span><a name="line-328"></a><span>
</span><a name="line-329"></a><span class="hs-comment">{- | Returns the estimated time remaining, in standard time units. 

Returns 0 whenever 'getSpeed' would return 0.

See the comments under 'getSpeed' for information about this function's type
and result. -}</span><span>
</span><a name="line-335"></a><span class="hs-identifier">getETR</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Data.Progress.Tracker.html#ProgressStatuses"><span class="hs-identifier hs-type">ProgressStatuses</span></a><span> </span><a href="#local-6989586621679077201"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">Integer</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-336"></a><span>           </span><a href="Data.Progress.Tracker.html#ProgressStatuses"><span class="hs-identifier hs-type">ProgressStatuses</span></a><span> </span><a href="#local-6989586621679077201"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">Rational</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679077201"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">Integer</span><span>
</span><a name="line-337"></a><a name="getETR"><a href="Data.Progress.Tracker.html#getETR"><span class="hs-identifier">getETR</span></a></a><span> </span><a name="local-6989586621679077247"><a href="#local-6989586621679077247"><span class="hs-identifier">po</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span>
</span><a name="line-338"></a><span>    </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621679077248"><a href="#local-6989586621679077248"><span class="hs-identifier">speed</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="Data.Progress.Tracker.html#getSpeed"><span class="hs-identifier hs-var">getSpeed</span></a><span> </span><a href="#local-6989586621679077247"><span class="hs-identifier hs-var">po</span></a><span class="hs-special">)</span><span class="hs-glyph">::</span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">Rational</span><span class="hs-special">)</span><span>
</span><a name="line-339"></a><span>       </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679077248"><span class="hs-identifier hs-var">speed</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-340"></a><span>          </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-341"></a><span>          </span><span class="hs-keyword">else</span><span> </span><span>
</span><a name="line-342"></a><span>              </span><span class="hs-comment">-- FIXME: potential for a race condition here, but it should</span><span>
</span><a name="line-343"></a><span>              </span><span class="hs-comment">-- be negligible</span><span>
</span><a name="line-344"></a><span>              </span><a href="Data.Progress.Tracker.html#withStatus"><span class="hs-identifier hs-var">withStatus</span></a><span> </span><a href="#local-6989586621679077247"><span class="hs-identifier hs-var">po</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679077249"><a href="#local-6989586621679077249"><span class="hs-identifier">status</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-345"></a><span>                  </span><span class="hs-keyword">do</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679077250"><a href="#local-6989586621679077250"><span class="hs-identifier">remaining</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">totalUnits</span><span> </span><a href="#local-6989586621679077249"><span class="hs-identifier hs-var">status</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-identifier">completedUnits</span><span> </span><a href="#local-6989586621679077249"><span class="hs-identifier hs-var">status</span></a><span>
</span><a name="line-346"></a><span>                     </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">round</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">toRational</span><span> </span><a href="#local-6989586621679077250"><span class="hs-identifier hs-var">remaining</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">/</span><span> </span><a href="#local-6989586621679077248"><span class="hs-identifier hs-var">speed</span></a><span>
</span><a name="line-347"></a><span>
</span><a name="line-348"></a><span class="hs-comment">{- | Returns the estimated system clock time of completion, in standard
time units.  Returns the current time whenever 'getETR' would return 0.

See the comments under 'getSpeed' for information about this function's type
and result. -}</span><span>
</span><a name="line-353"></a><span class="hs-identifier">getETA</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Data.Progress.Tracker.html#ProgressStatuses"><span class="hs-identifier hs-type">ProgressStatuses</span></a><span> </span><a href="#local-6989586621679077200"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">Integer</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-354"></a><span>           </span><a href="Data.Progress.Tracker.html#ProgressStatuses"><span class="hs-identifier hs-type">ProgressStatuses</span></a><span> </span><a href="#local-6989586621679077200"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">Rational</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679077200"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">Integer</span><span>
</span><a name="line-355"></a><a name="getETA"><a href="Data.Progress.Tracker.html#getETA"><span class="hs-identifier">getETA</span></a></a><span> </span><a name="local-6989586621679077251"><a href="#local-6989586621679077251"><span class="hs-identifier">po</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-356"></a><span>    </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621679077252"><a href="#local-6989586621679077252"><span class="hs-identifier">etr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Progress.Tracker.html#getETR"><span class="hs-identifier hs-var">getETR</span></a><span> </span><a href="#local-6989586621679077251"><span class="hs-identifier hs-var">po</span></a><span>
</span><a name="line-357"></a><span>       </span><span class="hs-comment">-- FIXME: similar race potential here</span><span>
</span><a name="line-358"></a><span>       </span><a href="Data.Progress.Tracker.html#withStatus"><span class="hs-identifier hs-var">withStatus</span></a><span> </span><a href="#local-6989586621679077251"><span class="hs-identifier hs-var">po</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679077253"><a href="#local-6989586621679077253"><span class="hs-identifier">status</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-359"></a><span>           </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621679077254"><a href="#local-6989586621679077254"><span class="hs-identifier">timenow</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">timeSource</span><span> </span><a href="#local-6989586621679077253"><span class="hs-identifier hs-var">status</span></a><span>
</span><a name="line-360"></a><span>              </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679077254"><span class="hs-identifier hs-var">timenow</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621679077252"><span class="hs-identifier hs-var">etr</span></a><span>
</span><a name="line-361"></a><span>
</span><a name="line-362"></a><span class="hs-comment">----------------------------------------------------------------------</span><span>
</span><a name="line-363"></a><span class="hs-comment">-- Utilities</span><span>
</span><a name="line-364"></a><span class="hs-comment">----------------------------------------------------------------------</span><span>
</span><a name="line-365"></a><span class="hs-comment">{- | The default time source for the system.  This is defined as:

&gt;getClockTime &gt;&gt;= (return . clockTimeToEpoch)
-}</span><span>
</span><a name="line-369"></a><span class="hs-identifier">defaultTimeSource</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Progress.Tracker.html#ProgressTimeSource"><span class="hs-identifier hs-type">ProgressTimeSource</span></a><span>
</span><a name="line-370"></a><a name="defaultTimeSource"><a href="Data.Progress.Tracker.html#defaultTimeSource"><span class="hs-identifier">defaultTimeSource</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">getClockTime</span><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="System.Time.Utils.html#clockTimeToEpoch"><span class="hs-identifier hs-var">clockTimeToEpoch</span></a><span class="hs-special">)</span><span>
</span><a name="line-371"></a><span>
</span><a name="line-372"></a><span class="hs-identifier">now</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Progress.Tracker.html#ProgressRecords"><span class="hs-identifier hs-type">ProgressRecords</span></a><span> </span><a href="#local-6989586621679077199"><span class="hs-identifier hs-type">a</span></a><span> </span><a href="Data.Progress.Tracker.html#ProgressTimeSource"><span class="hs-identifier hs-type">ProgressTimeSource</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679077199"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Progress.Tracker.html#ProgressTimeSource"><span class="hs-identifier hs-type">ProgressTimeSource</span></a><span>
</span><a name="line-373"></a><a name="now"><a href="Data.Progress.Tracker.html#now"><span class="hs-identifier">now</span></a></a><span> </span><a name="local-6989586621679077255"><a href="#local-6989586621679077255"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Progress.Tracker.html#withRecord"><span class="hs-identifier hs-var">withRecord</span></a><span> </span><a href="#local-6989586621679077255"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">timeSource</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">status</span><span class="hs-special">)</span><span>
</span><a name="line-374"></a><span>
</span><a name="line-375"></a><span class="hs-identifier">modStatus</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Progress.Tracker.html#Progress"><span class="hs-identifier hs-type">Progress</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Data.Progress.Tracker.html#ProgressStatus"><span class="hs-identifier hs-type">ProgressStatus</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Progress.Tracker.html#ProgressStatus"><span class="hs-identifier hs-type">ProgressStatus</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-376"></a><span class="hs-comment">-- FIXME/TODO: handle parents</span><span>
</span><a name="line-377"></a><a name="modStatus"><a href="Data.Progress.Tracker.html#modStatus"><span class="hs-identifier">modStatus</span></a></a><span> </span><span class="hs-special">(</span><a href="Data.Progress.Tracker.html#Progress"><span class="hs-identifier hs-var">Progress</span></a><span> </span><a name="local-6989586621679077256"><a href="#local-6989586621679077256"><span class="hs-identifier">mp</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679077257"><a href="#local-6989586621679077257"><span class="hs-identifier">func</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-378"></a><span>    </span><span class="hs-identifier hs-var">modifyMVar_</span><span> </span><a href="#local-6989586621679077256"><span class="hs-identifier hs-var">mp</span></a><span> </span><a href="#local-6989586621679077258"><span class="hs-identifier hs-var">modfunc</span></a><span>
</span><a name="line-379"></a><span>    </span><span class="hs-keyword">where</span><span> </span><span class="hs-identifier">modfunc</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Progress.Tracker.html#ProgressRecord"><span class="hs-identifier hs-type">ProgressRecord</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Data.Progress.Tracker.html#ProgressRecord"><span class="hs-identifier hs-type">ProgressRecord</span></a><span>
</span><a name="line-380"></a><span>          </span><a name="local-6989586621679077258"><a href="#local-6989586621679077258"><span class="hs-identifier">modfunc</span></a></a><span> </span><a name="local-6989586621679077259"><a href="#local-6989586621679077259"><span class="hs-identifier">oldpr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span>
</span><a name="line-381"></a><span>              </span><span class="hs-keyword">do</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679077260"><a href="#local-6989586621679077260"><span class="hs-identifier">newpr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679077259"><span class="hs-identifier hs-var">oldpr</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">status</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679077257"><span class="hs-identifier hs-var">func</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">status</span><span> </span><a href="#local-6989586621679077259"><span class="hs-identifier hs-var">oldpr</span></a><span class="hs-special">)</span><span class="hs-special">}</span><span>
</span><a name="line-382"></a><span>                 </span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679077261"><a href="#local-6989586621679077261"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679077261"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">status</span><span> </span><a href="#local-6989586621679077259"><span class="hs-identifier hs-var">oldpr</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">status</span><span> </span><a href="#local-6989586621679077260"><span class="hs-identifier hs-var">newpr</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-383"></a><span>                           </span><span class="hs-special">(</span><span class="hs-identifier">callbacks</span><span> </span><a href="#local-6989586621679077259"><span class="hs-identifier hs-var">oldpr</span></a><span class="hs-special">)</span><span>
</span><a name="line-384"></a><span>
</span><a name="line-385"></a><span>                 </span><span class="hs-comment">-- Kick it up to the parents.</span><span>
</span><a name="line-386"></a><span>                 </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">completedUnits</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">status</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679077260"><span class="hs-identifier hs-var">newpr</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-</span><span>
</span><a name="line-387"></a><span>                      </span><span class="hs-special">(</span><span class="hs-identifier">completedUnits</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">status</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679077259"><span class="hs-identifier hs-var">oldpr</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-388"></a><span>                   </span><span class="hs-number">0</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-389"></a><span>                   </span><a name="local-6989586621679077262"><a href="#local-6989586621679077262"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Progress.Tracker.html#callParents"><span class="hs-identifier hs-var">callParents</span></a><span> </span><a href="#local-6989586621679077260"><span class="hs-identifier hs-var">newpr</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679077263"><a href="#local-6989586621679077263"><span class="hs-identifier">y</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Progress.Tracker.html#incrP%27"><span class="hs-identifier hs-var">incrP'</span></a><span> </span><a href="#local-6989586621679077263"><span class="hs-identifier hs-var">y</span></a><span> </span><a href="#local-6989586621679077262"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span>
</span><a name="line-390"></a><span>                 </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">totalUnits</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">status</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679077260"><span class="hs-identifier hs-var">newpr</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-</span><span>
</span><a name="line-391"></a><span>                      </span><span class="hs-special">(</span><span class="hs-identifier">totalUnits</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">status</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679077259"><span class="hs-identifier hs-var">oldpr</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-392"></a><span>                   </span><span class="hs-number">0</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-393"></a><span>                   </span><a name="local-6989586621679077264"><a href="#local-6989586621679077264"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Progress.Tracker.html#callParents"><span class="hs-identifier hs-var">callParents</span></a><span> </span><a href="#local-6989586621679077260"><span class="hs-identifier hs-var">newpr</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679077265"><a href="#local-6989586621679077265"><span class="hs-identifier">y</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Progress.Tracker.html#incrTotal"><span class="hs-identifier hs-var">incrTotal</span></a><span> </span><a href="#local-6989586621679077265"><span class="hs-identifier hs-var">y</span></a><span> </span><a href="#local-6989586621679077264"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span>
</span><a name="line-394"></a><span>                 </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679077260"><span class="hs-identifier hs-var">newpr</span></a><span>
</span><a name="line-395"></a><span>
</span><a name="line-396"></a><span class="hs-identifier">callParents</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Progress.Tracker.html#ProgressRecord"><span class="hs-identifier hs-type">ProgressRecord</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Data.Progress.Tracker.html#Progress"><span class="hs-identifier hs-type">Progress</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-397"></a><a name="callParents"><a href="Data.Progress.Tracker.html#callParents"><span class="hs-identifier">callParents</span></a></a><span> </span><a name="local-6989586621679077266"><a href="#local-6989586621679077266"><span class="hs-identifier">pr</span></a></a><span> </span><a name="local-6989586621679077267"><a href="#local-6989586621679077267"><span class="hs-identifier">func</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapM_</span><span> </span><a href="#local-6989586621679077267"><span class="hs-identifier hs-var">func</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">parents</span><span> </span><a href="#local-6989586621679077266"><span class="hs-identifier hs-var">pr</span></a><span class="hs-special">)</span><span>
</span><a name="line-398"></a><span>
</span><a name="line-399"></a></pre></body></html>
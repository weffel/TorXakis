<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{- arch-tag: Generic Server Support
Copyright (c) 2004-2011 John Goerzen &lt;jgoerzen@complete.org&gt;

All rights reserved.

For license and copyright information, see the file LICENSE
-}</span><span>
</span><a name="line-8"></a><span>
</span><a name="line-9"></a><span class="hs-comment">{- |
   Module     : Network.SocketServer
   Copyright  : Copyright (C) 2004-2011 John Goerzen
   License    : BSD3

   Maintainer : John Goerzen &lt;jgoerzen@complete.org&gt; 
   Stability  : experimental
   Portability: systems with networking

This module provides an infrastructure to simplify server design.

Written by John Goerzen, jgoerzen\@complete.org

Please note: this module is designed to work with TCP, UDP, and Unix domain
sockets, but only TCP sockets have been tested to date.

This module is presently under-documented.  For an example of usage, please
see the description of &quot;Network.FTP.Server&quot;.
-}</span><span>
</span><a name="line-28"></a><span>
</span><a name="line-29"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">SocketServer</span><span class="hs-special">(</span><span class="hs-comment">-- * Generic Options and Types</span><span>
</span><a name="line-30"></a><span>                                     </span><a href="Network.SocketServer.html#InetServerOptions"><span class="hs-identifier hs-type">InetServerOptions</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-31"></a><span>                                     </span><a href="Network.SocketServer.html#simpleTCPOptions"><span class="hs-identifier hs-var">simpleTCPOptions</span></a><span class="hs-special">,</span><span>
</span><a name="line-32"></a><span>                                     </span><a href="Network.SocketServer.html#SocketServer"><span class="hs-identifier hs-type">SocketServer</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-33"></a><span>                                     </span><a href="Network.SocketServer.html#HandlerT"><span class="hs-identifier hs-type">HandlerT</span></a><span class="hs-special">,</span><span>
</span><a name="line-34"></a><span>                                     </span><span class="hs-comment">-- * TCP server convenient setup</span><span>
</span><a name="line-35"></a><span>                                     </span><a href="Network.SocketServer.html#serveTCPforever"><span class="hs-identifier hs-var">serveTCPforever</span></a><span class="hs-special">,</span><span>
</span><a name="line-36"></a><span>                                     </span><span class="hs-comment">-- * Lower-Level Processing</span><span>
</span><a name="line-37"></a><span>                                     </span><a href="Network.SocketServer.html#setupSocketServer"><span class="hs-identifier hs-var">setupSocketServer</span></a><span class="hs-special">,</span><span>
</span><a name="line-38"></a><span>                                     </span><a href="Network.SocketServer.html#handleOne"><span class="hs-identifier hs-var">handleOne</span></a><span class="hs-special">,</span><span>
</span><a name="line-39"></a><span>                                     </span><a href="Network.SocketServer.html#serveForever"><span class="hs-identifier hs-var">serveForever</span></a><span class="hs-special">,</span><span>
</span><a name="line-40"></a><span>                                     </span><a href="Network.SocketServer.html#closeSocketServer"><span class="hs-identifier hs-var">closeSocketServer</span></a><span class="hs-special">,</span><span>
</span><a name="line-41"></a><span>                                     </span><span class="hs-comment">-- * Combinators</span><span>
</span><a name="line-42"></a><span>                                     </span><a href="Network.SocketServer.html#loggingHandler"><span class="hs-identifier hs-var">loggingHandler</span></a><span class="hs-special">,</span><span>
</span><a name="line-43"></a><span>                                     </span><a href="Network.SocketServer.html#threadedHandler"><span class="hs-identifier hs-var">threadedHandler</span></a><span class="hs-special">,</span><span>
</span><a name="line-44"></a><span>                                     </span><a href="Network.SocketServer.html#handleHandler"><span class="hs-identifier hs-var">handleHandler</span></a><span>
</span><a name="line-45"></a><span>                                    </span><span class="hs-special">)</span><span>
</span><a name="line-46"></a><span class="hs-keyword">where</span><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">Socket</span><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">BSD</span><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span> </span><a href="Network.Utils.html"><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">Utils</span></a><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Concurrent</span><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System</span><span class="hs-operator">.</span><span class="hs-identifier">IO</span><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">System</span><span class="hs-operator">.</span><span class="hs-identifier">Log</span><span class="hs-operator">.</span><span class="hs-identifier">Logger</span><span>
</span><a name="line-53"></a><span>
</span><a name="line-54"></a><span class="hs-comment">{- | Options for your server. -}</span><span>
</span><a name="line-55"></a><span class="hs-keyword">data</span><span> </span><a name="InetServerOptions"><a href="Network.SocketServer.html#InetServerOptions"><span class="hs-identifier">InetServerOptions</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="InetServerOptions"><a href="Network.SocketServer.html#InetServerOptions"><span class="hs-identifier">InetServerOptions</span></a></a><span> </span><span class="hs-special">{</span><a name="listenQueueSize"><a href="Network.SocketServer.html#listenQueueSize"><span class="hs-identifier">listenQueueSize</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span>
</span><a name="line-56"></a><span>                                             </span><a name="portNumber"><a href="Network.SocketServer.html#portNumber"><span class="hs-identifier">portNumber</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">PortNumber</span><span class="hs-special">,</span><span>
</span><a name="line-57"></a><span>                                             </span><a name="interface"><a href="Network.SocketServer.html#interface"><span class="hs-identifier">interface</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HostAddress</span><span class="hs-special">,</span><span>
</span><a name="line-58"></a><span>                                             </span><a name="reuse"><a href="Network.SocketServer.html#reuse"><span class="hs-identifier">reuse</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">,</span><span>
</span><a name="line-59"></a><span>                                             </span><span class="hs-keyword">family</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Family</span><span class="hs-special">,</span><span>
</span><a name="line-60"></a><span>                                             </span><a name="sockType"><a href="Network.SocketServer.html#sockType"><span class="hs-identifier">sockType</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SocketType</span><span class="hs-special">,</span><span>
</span><a name="line-61"></a><span>                                             </span><a name="protoStr"><a href="Network.SocketServer.html#protoStr"><span class="hs-identifier">protoStr</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-62"></a><span>                                            </span><span class="hs-special">}</span><span>
</span><a name="line-63"></a><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Show</span><span class="hs-special">)</span><span>
</span><a name="line-64"></a><span>
</span><a name="line-65"></a><span class="hs-comment">{- | The main handler type.

The first parameter is the socket itself.

The second is the address of the remote endpoint.

The third is the address of the local endpoint.
-}</span><span>
</span><a name="line-73"></a><span class="hs-keyword">type</span><span> </span><a name="HandlerT"><a href="Network.SocketServer.html#HandlerT"><span class="hs-identifier">HandlerT</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Socket</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SockAddr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SockAddr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-74"></a><span>                     </span><span>
</span><a name="line-75"></a><span class="hs-comment">{- | Get Default options.  You can always modify it later. -}</span><span>
</span><a name="line-76"></a><span class="hs-identifier">simpleTCPOptions</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>                </span><span class="hs-comment">-- ^ Port Number</span><span>
</span><a name="line-77"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.SocketServer.html#InetServerOptions"><span class="hs-identifier hs-type">InetServerOptions</span></a><span>
</span><a name="line-78"></a><a name="simpleTCPOptions"><a href="Network.SocketServer.html#simpleTCPOptions"><span class="hs-identifier">simpleTCPOptions</span></a></a><span> </span><a name="local-6989586621679073335"><a href="#local-6989586621679073335"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.SocketServer.html#InetServerOptions"><span class="hs-identifier hs-var">InetServerOptions</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">listenQueueSize</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">5</span><span class="hs-special">,</span><span>
</span><a name="line-79"></a><span>                                        </span><span class="hs-identifier">portNumber</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><a href="#local-6989586621679073335"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-80"></a><span>                                        </span><span class="hs-identifier">interface</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">iNADDR_ANY</span><span class="hs-special">,</span><span>
</span><a name="line-81"></a><span>                                        </span><span class="hs-identifier">reuse</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span>
</span><a name="line-82"></a><span>                                        </span><span class="hs-keyword">family</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">AF_INET</span><span class="hs-special">,</span><span>
</span><a name="line-83"></a><span>                                        </span><span class="hs-identifier">sockType</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Stream</span><span class="hs-special">,</span><span>
</span><a name="line-84"></a><span>                                        </span><span class="hs-identifier">protoStr</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;tcp&quot;</span><span>
</span><a name="line-85"></a><span>                                       </span><span class="hs-special">}</span><span>
</span><a name="line-86"></a><span>
</span><a name="line-87"></a><span class="hs-keyword">data</span><span> </span><a name="SocketServer"><a href="Network.SocketServer.html#SocketServer"><span class="hs-identifier">SocketServer</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="SocketServer"><a href="Network.SocketServer.html#SocketServer"><span class="hs-identifier">SocketServer</span></a></a><span> </span><span class="hs-special">{</span><a name="optionsSS"><a href="Network.SocketServer.html#optionsSS"><span class="hs-identifier">optionsSS</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.SocketServer.html#InetServerOptions"><span class="hs-identifier hs-type">InetServerOptions</span></a><span class="hs-special">,</span><span>
</span><a name="line-88"></a><span>                                  </span><a name="sockSS"><a href="Network.SocketServer.html#sockSS"><span class="hs-identifier">sockSS</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Socket</span><span class="hs-special">}</span><span>
</span><a name="line-89"></a><span>                  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Show</span><span class="hs-special">)</span><span>
</span><a name="line-90"></a><span>
</span><a name="line-91"></a><span class="hs-comment">{- | Takes some options and sets up the 'SocketServer'.  I will bind
and begin listening, but will not accept any connections itself. -}</span><span>
</span><a name="line-93"></a><span class="hs-identifier">setupSocketServer</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.SocketServer.html#InetServerOptions"><span class="hs-identifier hs-type">InetServerOptions</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Network.SocketServer.html#SocketServer"><span class="hs-identifier hs-type">SocketServer</span></a><span>
</span><a name="line-94"></a><a name="setupSocketServer"><a href="Network.SocketServer.html#setupSocketServer"><span class="hs-identifier">setupSocketServer</span></a></a><span> </span><a name="local-6989586621679073336"><a href="#local-6989586621679073336"><span class="hs-identifier">opts</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-95"></a><span>    </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621679073337"><a href="#local-6989586621679073337"><span class="hs-identifier">proto</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getProtocolNumber</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">protoStr</span><span> </span><a href="#local-6989586621679073336"><span class="hs-identifier hs-var">opts</span></a><span class="hs-special">)</span><span>
</span><a name="line-96"></a><span>       </span><a name="local-6989586621679073338"><a href="#local-6989586621679073338"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">socket</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">family</span><span> </span><a href="#local-6989586621679073336"><span class="hs-identifier hs-var">opts</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">sockType</span><span> </span><a href="#local-6989586621679073336"><span class="hs-identifier hs-var">opts</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679073337"><span class="hs-identifier hs-var">proto</span></a><span>
</span><a name="line-97"></a><span>       </span><span class="hs-identifier hs-var">setSocketOption</span><span> </span><a href="#local-6989586621679073338"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-identifier hs-var">ReuseAddr</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">reuse</span><span> </span><a href="#local-6989586621679073336"><span class="hs-identifier hs-var">opts</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-98"></a><span>                                    </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-99"></a><span>                                    </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span>
</span><a name="line-100"></a><span>       </span><span class="hs-identifier hs-var">bindSocket</span><span> </span><a href="#local-6989586621679073338"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">SockAddrInet</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">portNumber</span><span> </span><a href="#local-6989586621679073336"><span class="hs-identifier hs-var">opts</span></a><span class="hs-special">)</span><span>
</span><a name="line-101"></a><span>                     </span><span class="hs-special">(</span><span class="hs-identifier">interface</span><span> </span><a href="#local-6989586621679073336"><span class="hs-identifier hs-var">opts</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-102"></a><span>       </span><span class="hs-identifier hs-var">listen</span><span> </span><a href="#local-6989586621679073338"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">listenQueueSize</span><span> </span><a href="#local-6989586621679073336"><span class="hs-identifier hs-var">opts</span></a><span class="hs-special">)</span><span>
</span><a name="line-103"></a><span>       </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Network.SocketServer.html#SocketServer"><span class="hs-identifier hs-var">SocketServer</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">optionsSS</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679073336"><span class="hs-identifier hs-var">opts</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sockSS</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679073338"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">}</span><span>
</span><a name="line-104"></a><span>
</span><a name="line-105"></a><span class="hs-comment">{- | Close the socket server.  Does not terminate active
handlers, if any. -}</span><span>
</span><a name="line-107"></a><span class="hs-identifier">closeSocketServer</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.SocketServer.html#SocketServer"><span class="hs-identifier hs-type">SocketServer</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-108"></a><a name="closeSocketServer"><a href="Network.SocketServer.html#closeSocketServer"><span class="hs-identifier">closeSocketServer</span></a></a><span> </span><a name="local-6989586621679073339"><a href="#local-6989586621679073339"><span class="hs-identifier">ss</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-109"></a><span>    </span><span class="hs-identifier hs-var">sClose</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">sockSS</span><span> </span><a href="#local-6989586621679073339"><span class="hs-identifier hs-var">ss</span></a><span class="hs-special">)</span><span>
</span><a name="line-110"></a><span>       </span><span>
</span><a name="line-111"></a><span class="hs-comment">{- | Handle one incoming request from the given 'SocketServer'. -}</span><span>
</span><a name="line-112"></a><span class="hs-identifier">handleOne</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.SocketServer.html#SocketServer"><span class="hs-identifier hs-type">SocketServer</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.SocketServer.html#HandlerT"><span class="hs-identifier hs-type">HandlerT</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-113"></a><a name="handleOne"><a href="Network.SocketServer.html#handleOne"><span class="hs-identifier">handleOne</span></a></a><span> </span><a name="local-6989586621679073340"><a href="#local-6989586621679073340"><span class="hs-identifier">ss</span></a></a><span> </span><a name="local-6989586621679073341"><a href="#local-6989586621679073341"><span class="hs-identifier">func</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-114"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679073342"><a href="#local-6989586621679073342"><span class="hs-identifier">opts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">optionsSS</span><span> </span><a href="#local-6989586621679073340"><span class="hs-identifier hs-var">ss</span></a><span class="hs-special">)</span><span>
</span><a name="line-115"></a><span>        </span><span class="hs-keyword">in</span><span>    </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621679073343"><a href="#local-6989586621679073343"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">accept</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">sockSS</span><span> </span><a href="#local-6989586621679073340"><span class="hs-identifier hs-var">ss</span></a><span class="hs-special">)</span><span>
</span><a name="line-116"></a><span>                 </span><a name="local-6989586621679073344"><a href="#local-6989586621679073344"><span class="hs-identifier">localaddr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getSocketName</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fst</span><span> </span><a href="#local-6989586621679073343"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-117"></a><span>                 </span><a href="#local-6989586621679073341"><span class="hs-identifier hs-var">func</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fst</span><span> </span><a href="#local-6989586621679073343"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">snd</span><span> </span><a href="#local-6989586621679073343"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679073344"><span class="hs-identifier hs-var">localaddr</span></a><span>
</span><a name="line-118"></a><span>    </span><span>
</span><a name="line-119"></a><span class="hs-comment">{- | Handle all incoming requests from the given 'SocketServer'. -}</span><span>
</span><a name="line-120"></a><span class="hs-identifier">serveForever</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.SocketServer.html#SocketServer"><span class="hs-identifier hs-type">SocketServer</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.SocketServer.html#HandlerT"><span class="hs-identifier hs-type">HandlerT</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-121"></a><a name="serveForever"><a href="Network.SocketServer.html#serveForever"><span class="hs-identifier">serveForever</span></a></a><span> </span><a name="local-6989586621679073345"><a href="#local-6989586621679073345"><span class="hs-identifier">ss</span></a></a><span> </span><a name="local-6989586621679073346"><a href="#local-6989586621679073346"><span class="hs-identifier">func</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-122"></a><span>    </span><span class="hs-identifier hs-var">sequence_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">repeat</span><span> </span><span class="hs-special">(</span><a href="Network.SocketServer.html#handleOne"><span class="hs-identifier hs-var">handleOne</span></a><span> </span><a href="#local-6989586621679073345"><span class="hs-identifier hs-var">ss</span></a><span> </span><a href="#local-6989586621679073346"><span class="hs-identifier hs-var">func</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-123"></a><span>
</span><a name="line-124"></a><span class="hs-comment">{- | Convenience function to completely set up a TCP
'SocketServer' and handle all incoming requests.

This function is literally this:

&gt;serveTCPforever options func =
&gt;    do sockserv &lt;- setupSocketServer options
&gt;       serveForever sockserv func
 -}</span><span>
</span><a name="line-133"></a><span class="hs-identifier">serveTCPforever</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.SocketServer.html#InetServerOptions"><span class="hs-identifier hs-type">InetServerOptions</span></a><span>     </span><span class="hs-comment">-- ^ Server options</span><span>
</span><a name="line-134"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.SocketServer.html#HandlerT"><span class="hs-identifier hs-type">HandlerT</span></a><span>              </span><span class="hs-comment">-- ^ Handler function</span><span>
</span><a name="line-135"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>                </span><span>
</span><a name="line-136"></a><a name="serveTCPforever"><a href="Network.SocketServer.html#serveTCPforever"><span class="hs-identifier">serveTCPforever</span></a></a><span> </span><a name="local-6989586621679073347"><a href="#local-6989586621679073347"><span class="hs-identifier">options</span></a></a><span> </span><a name="local-6989586621679073348"><a href="#local-6989586621679073348"><span class="hs-identifier">func</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-137"></a><span>    </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621679073349"><a href="#local-6989586621679073349"><span class="hs-identifier">sockserv</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Network.SocketServer.html#setupSocketServer"><span class="hs-identifier hs-var">setupSocketServer</span></a><span> </span><a href="#local-6989586621679073347"><span class="hs-identifier hs-var">options</span></a><span>
</span><a name="line-138"></a><span>       </span><a href="Network.SocketServer.html#serveForever"><span class="hs-identifier hs-var">serveForever</span></a><span> </span><a href="#local-6989586621679073349"><span class="hs-identifier hs-var">sockserv</span></a><span> </span><a href="#local-6989586621679073348"><span class="hs-identifier hs-var">func</span></a><span>
</span><a name="line-139"></a><span>
</span><a name="line-140"></a><span class="hs-comment">----------------------------------------------------------------------</span><span>
</span><a name="line-141"></a><span class="hs-comment">-- Combinators</span><span>
</span><a name="line-142"></a><span class="hs-comment">----------------------------------------------------------------------</span><span>
</span><a name="line-143"></a><span>
</span><a name="line-144"></a><span class="hs-comment">{- | Log each incoming connection using the interface in
&quot;System.Log.Logger&quot;.

Log when the incoming connection disconnects.

Also, log any failures that may occur in the child handler. -}</span><span>
</span><a name="line-150"></a><span>
</span><a name="line-151"></a><span class="hs-identifier">loggingHandler</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span>                </span><span class="hs-comment">-- ^ Name of logger to use</span><span>
</span><a name="line-152"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">System</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Log</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Logger</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Priority</span><span> </span><span class="hs-comment">-- ^ Priority of logged messages</span><span>
</span><a name="line-153"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.SocketServer.html#HandlerT"><span class="hs-identifier hs-type">HandlerT</span></a><span>              </span><span class="hs-comment">-- ^ Handler to call after logging</span><span>
</span><a name="line-154"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.SocketServer.html#HandlerT"><span class="hs-identifier hs-type">HandlerT</span></a><span>              </span><span class="hs-comment">-- ^ Resulting handler</span><span>
</span><a name="line-155"></a><a name="loggingHandler"><a href="Network.SocketServer.html#loggingHandler"><span class="hs-identifier">loggingHandler</span></a></a><span> </span><a name="local-6989586621679073350"><a href="#local-6989586621679073350"><span class="hs-identifier">hname</span></a></a><span> </span><a name="local-6989586621679073351"><a href="#local-6989586621679073351"><span class="hs-identifier">prio</span></a></a><span> </span><a name="local-6989586621679073352"><a href="#local-6989586621679073352"><span class="hs-identifier">nexth</span></a></a><span> </span><a name="local-6989586621679073353"><a href="#local-6989586621679073353"><span class="hs-identifier">socket</span></a></a><span> </span><a name="local-6989586621679073354"><a href="#local-6989586621679073354"><span class="hs-identifier">r_sockaddr</span></a></a><span> </span><a name="local-6989586621679073355"><a href="#local-6989586621679073355"><span class="hs-identifier">l_sockaddr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span>
</span><a name="line-156"></a><span>    </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621679073356"><a href="#local-6989586621679073356"><span class="hs-identifier">sockStr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Network.Utils.html#showSockAddr"><span class="hs-identifier hs-var">showSockAddr</span></a><span> </span><a href="#local-6989586621679073354"><span class="hs-identifier hs-var">r_sockaddr</span></a><span>
</span><a name="line-157"></a><span>       </span><span class="hs-identifier hs-var">System</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">Log</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">Logger</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">logM</span><span> </span><a href="#local-6989586621679073350"><span class="hs-identifier hs-var">hname</span></a><span> </span><a href="#local-6989586621679073351"><span class="hs-identifier hs-var">prio</span></a><span> </span><span>
</span><a name="line-158"></a><span>                   </span><span class="hs-special">(</span><span class="hs-string">&quot;Received connection from &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679073356"><span class="hs-identifier hs-var">sockStr</span></a><span class="hs-special">)</span><span>
</span><a name="line-159"></a><span>       </span><span class="hs-identifier hs-var">System</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">Log</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">Logger</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">traplogging</span><span> </span><a href="#local-6989586621679073350"><span class="hs-identifier hs-var">hname</span></a><span> </span><span>
</span><a name="line-160"></a><span>               </span><span class="hs-identifier hs-var">System</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">Log</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">Logger</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">WARNING</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679073352"><span class="hs-identifier hs-var">nexth</span></a><span> </span><a href="#local-6989586621679073353"><span class="hs-identifier hs-var">socket</span></a><span> </span><a href="#local-6989586621679073354"><span class="hs-identifier hs-var">r_sockaddr</span></a><span> </span><span>
</span><a name="line-161"></a><span>                                                   </span><a href="#local-6989586621679073355"><span class="hs-identifier hs-var">l_sockaddr</span></a><span class="hs-special">)</span><span>
</span><a name="line-162"></a><span>       </span><span class="hs-identifier hs-var">System</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">Log</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">Logger</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">logM</span><span> </span><a href="#local-6989586621679073350"><span class="hs-identifier hs-var">hname</span></a><span> </span><a href="#local-6989586621679073351"><span class="hs-identifier hs-var">prio</span></a><span>
</span><a name="line-163"></a><span>                   </span><span class="hs-special">(</span><span class="hs-string">&quot;Connection &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679073356"><span class="hs-identifier hs-var">sockStr</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; disconnected&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-164"></a><span>       </span><span>
</span><a name="line-165"></a><span>
</span><a name="line-166"></a><span class="hs-comment">-- | Handle each incoming connection in its own thread to</span><span>
</span><a name="line-167"></a><span class="hs-comment">-- make the server multi-tasking.</span><span>
</span><a name="line-168"></a><span class="hs-identifier">threadedHandler</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.SocketServer.html#HandlerT"><span class="hs-identifier hs-type">HandlerT</span></a><span>             </span><span class="hs-comment">-- ^ Handler to call in the new thread</span><span>
</span><a name="line-169"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.SocketServer.html#HandlerT"><span class="hs-identifier hs-type">HandlerT</span></a><span>             </span><span class="hs-comment">-- ^ Resulting handler</span><span>
</span><a name="line-170"></a><a name="threadedHandler"><a href="Network.SocketServer.html#threadedHandler"><span class="hs-identifier">threadedHandler</span></a></a><span> </span><a name="local-6989586621679073357"><a href="#local-6989586621679073357"><span class="hs-identifier">nexth</span></a></a><span> </span><a name="local-6989586621679073358"><a href="#local-6989586621679073358"><span class="hs-identifier">socket</span></a></a><span> </span><a name="local-6989586621679073359"><a href="#local-6989586621679073359"><span class="hs-identifier">r_sockaddr</span></a></a><span> </span><a name="local-6989586621679073360"><a href="#local-6989586621679073360"><span class="hs-identifier">l_sockaddr</span></a></a><span class="hs-glyph">=</span><span>
</span><a name="line-171"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-identifier hs-var">forkIO</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679073357"><span class="hs-identifier hs-var">nexth</span></a><span> </span><a href="#local-6989586621679073358"><span class="hs-identifier hs-var">socket</span></a><span> </span><a href="#local-6989586621679073359"><span class="hs-identifier hs-var">r_sockaddr</span></a><span> </span><a href="#local-6989586621679073360"><span class="hs-identifier hs-var">l_sockaddr</span></a><span class="hs-special">)</span><span>
</span><a name="line-172"></a><span>       </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-173"></a><span>
</span><a name="line-174"></a><span class="hs-comment">{- | Give your handler function a Handle instead of a Socket.

The Handle will be opened with ReadWriteMode (you use one handle for both
directions of the Socket).  Also, it will be initialized with LineBuffering.

Unlike other handlers, the handle will be closed when the function returns.
Therefore, if you are doing threading, you should to it before you call this
handler.
-}</span><span>
</span><a name="line-183"></a><span class="hs-identifier">handleHandler</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Handle</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SockAddr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SockAddr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>      </span><span class="hs-comment">-- ^ Handler to call</span><span>
</span><a name="line-184"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.SocketServer.html#HandlerT"><span class="hs-identifier hs-type">HandlerT</span></a><span>
</span><a name="line-185"></a><a name="handleHandler"><a href="Network.SocketServer.html#handleHandler"><span class="hs-identifier">handleHandler</span></a></a><span> </span><a name="local-6989586621679073361"><a href="#local-6989586621679073361"><span class="hs-identifier">func</span></a></a><span> </span><a name="local-6989586621679073362"><a href="#local-6989586621679073362"><span class="hs-identifier">socket</span></a></a><span> </span><a name="local-6989586621679073363"><a href="#local-6989586621679073363"><span class="hs-identifier">r_sockaddr</span></a></a><span> </span><a name="local-6989586621679073364"><a href="#local-6989586621679073364"><span class="hs-identifier">l_sockaddr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span>
</span><a name="line-186"></a><span>    </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621679073365"><a href="#local-6989586621679073365"><span class="hs-identifier">h</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">socketToHandle</span><span> </span><a href="#local-6989586621679073362"><span class="hs-identifier hs-var">socket</span></a><span> </span><span class="hs-identifier hs-var">ReadWriteMode</span><span>
</span><a name="line-187"></a><span>       </span><span class="hs-identifier hs-var">hSetBuffering</span><span> </span><a href="#local-6989586621679073365"><span class="hs-identifier hs-var">h</span></a><span> </span><span class="hs-identifier hs-var">LineBuffering</span><span>
</span><a name="line-188"></a><span>       </span><a href="#local-6989586621679073361"><span class="hs-identifier hs-var">func</span></a><span> </span><a href="#local-6989586621679073365"><span class="hs-identifier hs-var">h</span></a><span> </span><a href="#local-6989586621679073363"><span class="hs-identifier hs-var">r_sockaddr</span></a><span> </span><a href="#local-6989586621679073364"><span class="hs-identifier hs-var">l_sockaddr</span></a><span>
</span><a name="line-189"></a><span>       </span><span class="hs-identifier hs-var">hClose</span><span> </span><a href="#local-6989586621679073365"><span class="hs-identifier hs-var">h</span></a><span>
</span><a name="line-190"></a></pre></body></html>